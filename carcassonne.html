<!DOCTYPE html>
<html>
    <head>
        <title>
        </title>
        <link rel="stylesheet" type="text/css" href="carcassonne.css" />
    </head>
    <body>
        <div id="display"></div>
        <div id="board"></div>
    </body>
    <script src = "/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      let inHand = null;
      socket.on('tile', function(data) {
        inHand = data;
        console.log(inHand);
        let tile = document.createElement('img');
        tile.src = 'tiles/' + inHand.key + '.jpg';
        tile.id = inHand.key;
        tile.addEventListener('click', function() {
          rotate(inHand);
        });
        document.getElementById('display').appendChild(tile);
      });
      let seed = {sides: ["C", "R", "F", "R"], key: 'seed', rot: 0, new: false};
      /*let seed = {sides: ["C", "R", "F", "R"],
                    key: 'seed',
                    rot: 0,
                    meeple: {player: color, x: 0, y: 0}
                   };*/
      let board = [
        [0, 0 ,0],
        [0, seed, 0],
        [0, 0 ,0]
      ];
      set();
      function rotate(tile) {
        tile.sides.unshift(tile.sides.pop());
        tile.rot == 3 ? tile.rot = 0 : tile.rot++;
        let trg = document.getElementById(tile.key);
        trg.style.transform = 'rotate(' + 90 * tile.rot + 'deg)';
      }
      function set() {
        let play = document.getElementById('board');
        play.innerHTML = '';
        let tile;
        let pic;
        for (const [y, row] of board.entries()) {
          for (const [x, column] of row.entries()) {
            tile = document.createElement('div');
            tile.className = 'tile';
            tile.id = y + '.' + x;
            if (column == 0) {
              tile.addEventListener('click', function() {
                  validate(y, x);
              });
            } else {
              pic = document.createElement('img');
              pic.src = 'tiles/' + board[y][x].key + '.jpg';
              pic.className = 'pic';
              pic.id = board[y][x].key;
              pic.style.transform = 'rotate(' + 90 * board[y][x].rot + 'deg)';
              let id = tile.id;
              if (board[y][x].new) {
                pic.addEventListener('click', function() {
                    claim(event, id);
                });
                board[y][x].new = false;
              }
              tile.appendChild(pic);
            }
            play.appendChild(tile);
          }
        }
      }
      function pass() {
        socket.emit('pass', board)
      }
      function claim(event, id) {
        let meeple = document.createElement('img');
        meeple.src = "white.svg";
        meeple.className = 'meeple';
        meeple.addEventListener('click', function {
          reclaim();
        });
        meeple.style.top = event.clientY % 193 - 32 + 'px';
        meeple.style.left = event.clientX % 193 - 32 + 'px';
        document.getElementById(id).appendChild(meeple);
      };
      function reclaim() {
        return;
      };
      function validate(y, x) {
        let touching = 0;
        if (y - 1 >= 0) {
          if (board[y-1][x]) {
            if (board[y-1][x].sides[2] != inHand.sides[0]) {
              return;
            } else {
              touching++;
            }
          }
        }
        if (y + 1 <= board.length - 1) {
          if (board[y+1][x]) {
            if (board[y+1][x].sides[0] != inHand.sides[2]) {
              return;
            } else {
              touching++;
            }
          }
        }
        if (x - 1 >= 0) {
          if (board[y][x-1]) {
            if (board[y][x-1].sides[1] != inHand.sides[3]) {
              return;
            } else {
              touching++;
            }
          }
        }
        if (x + 1 <= board[0].length - 1) {
          if (board[y][x+1]) {
            if (board[y][x+1].sides[3] != inHand.sides[1]) {
              return;
            } else {
              touching++;
            }
          }
        }
        if (touching > 0) {
          inHand.new = true;
          place(y, x);
        } else {
          return;
        }
      }
      function place(y, x) {
        board[y][x] = inHand;
        let tile = document.createElement('img');
        tile.src = 'tiles/' + board[y][x].key + '.jpg';
        tile.id = board[y][x].key;
        document.getElementById(y + '.' + x).appendChild(tile);
        expand(y, x);
        socket.emit('placed');
      }
      function expand(y, x) {
        if (y == 0) {
          let row = [];
          let base = board[0].length;
          while (row.length != base) {
              row.push(0);
          }
          board.unshift(row);
        }
        if (y == board.length - 1) {
          let row = [];
          let base = board[0].length;
          while (row.length != base) {
              row.push(0);
          }
          board.push(row);
        }
        if (x == 0) {
          for (let row of board) {
              row.unshift(0);
          }
          document.documentElement.style.setProperty("--cols", board[0].length);
        }
        if (x == board[0].length - 1) {
          for (let row of board) {
              row.push(0);
          }
          document.documentElement.style.setProperty("--cols", board[0].length);
        }
        set();
      }
    </script>
</html>
