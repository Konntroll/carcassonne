<!DOCTYPE html>
<html>
    <head>
        <title>
          Carcassonne
        </title>
        <link rel="stylesheet" type="text/css" href="carcassonne.css" />
    </head>
    <body>
        <div id="create">
          <h1>Start a game.</h1>
          <input id="startGame" type="text" placeholder="Choose a name." onkeyup="createGame()">
          <button id="gamebtn" type="button" onclick="createGame()">Create!</button>
          <div id="games">
            <h1>Or join one of these:</h1>
          </div>
        </div>
        <div id="infoAndControls">
          <div id="info">
            <div class="stats">
              <div id="score" onwheel="changeScore()">0</div>
              <div class="tooltips" id="scoreTrackers">Scroll up or down to adjust your score.
                <div><hr>Player scores:</div>
              </div>
            </div>
            <svg id="token" version="1.0" xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 512.000000 512.000000">
              <g id='tokenColor' transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
              fill="orange" stroke="black" stroke-width="150">
              <path d="M2455 4564 c-157 -25 -314 -116 -418 -244 -92 -112 -164 -285 -187
              -445 -6 -44 -13 -94 -16 -111 -4 -27 -12 -35 -55 -54 -100 -43 -716 -349 -824
              -410 -280 -157 -461 -306 -523 -429 -85 -170 -40 -273 162 -371 152 -74 430
              -150 639 -175 31 -4 57 -9 57 -12 0 -3 -38 -62 -84 -132 -86 -129 -165 -236
              -401 -541 -307 -396 -399 -578 -412 -816 -10 -171 20 -238 117 -264 26 -7 265
              -10 717 -8 l678 3 46 27 c56 33 72 57 195 289 162 308 301 527 383 603 l31 30
              41 -40 c79 -77 214 -292 376 -598 120 -227 136 -251 192 -284 l46 -27 670 -3
              c462 -2 686 0 721 8 99 21 131 90 121 263 -13 240 -105 421 -412 817 -239 308
              -333 436 -411 555 -42 64 -74 118 -72 119 1 2 53 11 115 20 424 64 753 212
              779 352 33 176 -137 369 -520 592 -106 61 -847 432 -893 446 -15 5 -24 17 -27
              39 -40 281 -93 424 -211 567 -81 98 -200 177 -325 214 -54 17 -237 29 -295 20z"/>
              </g>
            </svg>
            <div id='meeplesLeft'>7</div>
            <img id="tileMarker" src="tiles\back.jpg"></img>
            <div id='tilesLeft'>71</div>
          </div>
          <div id="controls">
            <div class='btn' id="start" onclick="start()">Start
              <span class="tooltips">Begin playing.</span>
            </div>
            <div class='btn' id="done" onclick="done()">Done
              <span class="tooltips">Finish your turn.</span>
            </div>
            <div class='btn' id="discard" onclick="discard()">Discard
              <span class="tooltips">Discard an unplayable tile.</span>
            </div>
            <div class='btn' id="leave" onclick="leave()">Leave
              <span class="tooltips" id="startTT">Leave the game.</span>
            </div>
            <div id="rest"></div>
          </div>
        </div>
        <div id="display">
          <img src="tiles/back.jpg" id="hand" onclick="rotate()">
        </div>
        <div id="board"></div>
    </body>
    <script src = "/socket.io/socket.io.js"></script>
    <script>
      var socket = io();

      let hand = null;
      let color = '';
      let currentPlayer = '';
      let meeples = 7;
      let tilesRemaining = 0;
      let score = 0;
      let seed = {sides: ["C", "R", "F", "R"],
                  key: 'seed',
                  rot: 0,
                  claim: {by: 'seed'}};
      let board = [
        [0, 0 ,0],
        [0, seed, 0],
        [0, 0 ,0]
      ];

      socket.on('newPlayer', function(newColor) {
        color = newColor;
        document.getElementById('tokenColor').style.fill = color;
      });
      socket.on('stateUpdate', function(state) {
        currentPlayer = state.color;
        document.getElementById('tilesLeft').innerHTML = state.tiles;
      });
      socket.on('tile', function(data) {
        hand = data;
        let display = document.getElementById('hand');
        display.src = 'tiles/' + hand.key + '.jpg';
      });
      socket.on('update', function(update) {
        board = update;
        document.documentElement.style.setProperty("--cols", board[0].length);
        set();
      });
      socket.on('listGame', function(game) {
        makeGameEntry(game);
        toggleGameList();
      });
      socket.on('unlistGame', function (game) {
        let entry = document.getElementById(game);
        entry.parentNode.removeChild(entry);
        toggleGameList();
      });
      socket.on('welcome', function(games) {
        for (let game of games) {
          if (document.getElementById(game)) continue;
          makeGameEntry(game);
        }
        toggleGameList();
      });
      socket.on('gameStarted', function() {
        document.getElementById('start').style.display = 'none';
        document.getElementById('done').style.display = 'flex';
      })
      socket.on('scoreUpdate', function(data) {
        document.getElementById(data.color).innerHTML = data.score;
      });
      socket.on('createScoreTracker', function(color) {
        createScoreTracker(color);
      });
      socket.on('fetchScoreTrackers', function(colors) {
        for (let color of colors) {
          createScoreTracker(color);
        }
      });
      socket.on('removeScoreTracker', function(color) {
        removeScoreTracker(color);
      });
      function createScoreTracker(color) {
        let entry = document.createElement('div');
        entry.className = 'scores';
        entry.id = color + 'Player';
        let token = document.createElement('img');
        token.src = color + '.svg';
        token.className = "playerToken";
        let score = document.createElement('div');
        score.id = color;
        entry.appendChild(token);
        entry.appendChild(score);
        document.getElementById('scoreTrackers').appendChild(entry);
        document.getElementById(color).innerHTML = 0;
      }
      function removeScoreTracker(color) {
        let scoreTracker = document.getElementById(color + 'Player');
        scoreTracker.parentNode.removeChild(scoreTracker);
      }
      function changeScore() {
        score += event.deltaY * -0.01;
        if (score < 0) score = 0;
        document.getElementById('score').innerHTML = score;
        socket.emit('scoreUpdate', score);
      }
      function toggleGameList() {
        let games = document.getElementById('games');
        if (games.children.length > 1) {
          document.getElementById('games').style.display = "block";
        } else {
          document.getElementById('games').style.display = "none";
        }
      }
      function makeGameEntry(name) {
        let entry = document.createElement("div");
        entry.id = name;
        entry.className = 'gamesAvailable';
        let title = document.createTextNode(name);
        entry.onclick = function() {
          socket.emit('join', name);
          document.getElementById('create').style.display = "none";
          document.getElementById('display').style.display = 'block';
          document.getElementById('infoAndControls').style.display = 'flex';
        }
        entry.appendChild(title);
        document.getElementById('games').appendChild(entry);
      }
      function createGame() {
        if (event.keyCode === 13 || event.button === 0) {
          socket.emit('create', document.getElementById('startGame').value);
          document.getElementById('startGame').value = '';
          document.getElementById('create').style.display = "none";
          document.getElementById('display').style.display = 'block';
          document.getElementById('infoAndControls').style.display = 'flex';
        }
      }
      function leave() {
        depopulate();
        hand = null;
        let display = document.getElementById('hand');
        display.src = 'tiles/back.jpg';
        display.style.transform = 'rotate(0deg)';
        meeples = 7;
        score = 0;
        socket.emit('removeScoreTracker', color);
        color = '';
        document.getElementById('score').innerHTML = score;
        document.getElementById('meeplesLeft').innerHTML = meeples;
        socket.emit('leave', board);
        document.getElementById('board').innerHTML = '';
        board = [
          [0, 0 ,0],
          [0, seed, 0],
          [0, 0 ,0]
        ];
        document.getElementById('create').style.display = "block";
        document.getElementById('display').style.display = 'none';
        document.getElementById('infoAndControls').style.display = 'none';
        document.getElementById('start').style.display = 'flex';
        document.getElementById('done').style.display = 'none';
      }
      function rotate() {
        let tile = document.getElementById('hand');
        if (tile.src.charAt(tile.src.length - 5) == 'k') return;
        hand.sides.unshift(hand.sides.pop());
        hand.rot == 3 ? hand.rot = 0 : hand.rot++;
        tile.style.transform = 'rotate(' + 90 * hand.rot + 'deg)';
      }
      function set() {
        let play = document.getElementById('board');
        play.innerHTML = '';
        let tile;
        let pic;
        for (const [y, row] of board.entries()) {
          for (const [x, column] of row.entries()) {
            tile = document.createElement('div');
            tile.className = 'tile';
            tile.id = y + '.' + x;
            if (column == 0) {
              tile.addEventListener('click', function() {
                  if(validate(y, x)) place(y, x);
              });
            } else {
              pic = document.createElement('img');
              pic.src = 'tiles/' + board[y][x].key + '.jpg';
              pic.className = 'pic';
              pic.id = board[y][x].key;
              pic.style.transform = 'rotate(' + 90 * board[y][x].rot + 'deg)';
              pic.addEventListener('click', function() {
                if (board[y][x].claim.by || meeples == 0) return;
                board[y][x].claim.by = color;
                let offsetTop = document.documentElement.scrollTop - 75 - (y * 4);
                let offsetLeft = document.documentElement.scrollLeft - 15 - (x * 4);
                board[y][x].claim.top = (event.clientY + offsetTop) % 193 - 24 + 'px';
                board[y][x].claim.left = (event.clientX + offsetLeft) % 193 - 24 + 'px';
                meeples--;
                document.getElementById('meeplesLeft').innerHTML = meeples;
                claim(y, x);
              });
              tile.appendChild(pic);
            }
            play.appendChild(tile);
          }
        }
        populate();
      }
      function populate() {
        for (const [y, row] of board.entries()) {
          for (const [x, column] of row.entries()) {
            if (column == 0 || column.claim.by == 'seed') {
              continue;
            } else {
              if (column.claim.by) {
                claim(y, x);
              }
            }
          }
        }
      }
      function depopulate() {
        //this removes all the meeples placed by a player who
        //has just left the game with next update of the board
        for (const [y, row] of board.entries()) {
          for (const [x, column] of row.entries()) {
            if (column == 0 || column.claim.by == 'seed') {
              continue;
            } else {
              if (column.claim.by == color) {
                column.claim.by = null;
              }
            }
          }
        }
        socket.emit('depopulated', board);
      }
      function claim(y, x) {
        let meeple = document.createElement('img');
        meeple.src = board[y][x].claim.by + '.svg';
        meeple.className = 'meeple';
        meeple.id = x + 'meeple' + y
        meeple.style.top = board[y][x].claim.top;
        meeple.style.left = board[y][x].claim.left;
        meeple.addEventListener('click', function() {
          reclaim(y, x);
        });
        document.getElementById(y + '.' + x).appendChild(meeple);
      };
      function reclaim(y, x) {
        if (board[y][x].claim.by != color) return;
        document.getElementById(x + 'meeple' + y).remove();
        meeples++;
        document.getElementById('meeplesLeft').innerHTML = meeples;
        board[y][x].claim.by = null;
      };
      function validate(y, x) {
        let touching = 0;
        if (y - 1 >= 0) {
          if (board[y-1][x]) {
            if (board[y-1][x].sides[2] != hand.sides[0]) {
              return false;
            } else {
              touching++;
            }
          }
        }
        if (y + 1 <= board.length - 1) {
          if (board[y+1][x]) {
            if (board[y+1][x].sides[0] != hand.sides[2]) {
              return false;
            } else {
              touching++;
            }
          }
        }
        if (x - 1 >= 0) {
          if (board[y][x-1]) {
            if (board[y][x-1].sides[1] != hand.sides[3]) {
              return false;
            } else {
              touching++;
            }
          }
        }
        if (x + 1 <= board[0].length - 1) {
          if (board[y][x+1]) {
            if (board[y][x+1].sides[3] != hand.sides[1]) {
              return false;
            } else {
              touching++;
            }
          }
        }
        if (touching > 0) {
          return true;
        } else {
          return false;
        }
      }
      function place(y, x) {
        if (!hand) return;
        board[y][x] = hand;
        let tile = document.createElement('img');
        tile.src = 'tiles/' + board[y][x].key + '.jpg';
        tile.id = board[y][x].key;
        document.getElementById(y + '.' + x).appendChild(tile);
        expand(y, x);
        hand = null;
        let display = document.getElementById('hand');
        display.src = 'tiles/back.jpg';
        display.style.transform = 'rotate(0deg)';
      }
      function expand(y, x) {
        if (y == 0) {
          let row = [];
          let base = board[0].length;
          while (row.length != base) {
              row.push(0);
          }
          board.unshift(row);
        }
        if (y == board.length - 1) {
          let row = [];
          let base = board[0].length;
          while (row.length != base) {
              row.push(0);
          }
          board.push(row);
        }
        if (x == 0) {
          for (let row of board) {
              row.unshift(0);
          }
          document.documentElement.style.setProperty("--cols", board[0].length);
        }
        if (x == board[0].length - 1) {
          for (let row of board) {
              row.push(0);
          }
          document.documentElement.style.setProperty("--cols", board[0].length);
        }
        set();
      }
      function start() {
        socket.emit('start', board);
        document.getElementById('start').style.display = 'none';
        document.getElementById('done').style.display = 'flex';
      }
      function done() {
        if (!hand && currentPlayer == color) {
          socket.emit('done', board);
        }
      }
    </script>
</html>
