<!DOCTYPE html>
<html>
    <head>
        <title>
        </title>
        <link rel="stylesheet" type="text/css" href="carcassonne.css" />
    </head>
    <body>
        <div id="display"></div>
        <div id="board"></div>
    </body>
    <script src = "/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      let inHand = {sides: [], key: 0, rot: 0};
      socket.on('tile', function(data) {
        inHand.key = data.key;
        inHand.sides = data.sides;
        let tile = document.createElement('img');
        tile.src = 'tiles/' + data.key + '.jpg';
        tile.id = inHand.key;
        tile.addEventListener('click', function() {
          rotate(inHand);
        });
        document.getElementById('display').appendChild(tile);
      });
      let seed = {sides: ["C", "R", "F", "R"], key: 'seed', rot: 0};
      let board = [
        [0, 0 ,0],
        [0, seed, 0],
        [0, 0 ,0]
      ];
      set();
      function rotate(tile) {
        tile.sides.unshift(tile.sides.pop());
        tile.rot == 3 ? tile.rot = 0 : tile.rot++;
        document.getElementById(tile.key).style.transform = 'rotate(' + 90 * tile.rot + 'deg)';
      }
      function set() {
        let play = document.getElementById('board');
        play.innerHTML = '';
        let tile;
        for (const [y, row] of board.entries()) {
          for (const [x, column] of row.entries()) {
            if (column == 0) {
              tile = document.createElement('div');
              tile.className = 'tile';
              tile.id = y + '.' + x;
              tile.addEventListener('click', function() {
                  validate(y, x);
              });
            } else {
              tile = document.createElement('img');
              tile.src = 'tiles/' + board[y][x].key + '.jpg';
              tile.className = 'tile';
              tile.id = board[y][x].key;
              tile.style.transform = 'rotate(' + 90 * board[y][x].rot + 'deg)';
            }
            play.appendChild(tile);
          }
        }
      }
      function claim() {};
      function validate(y, x) {

        place(y, x);
      }
      function place(y, x) {
        board[y][x] = {sides: inHand.sides, key: inHand.key, rot: inHand.rot};
        let tile = document.createElement('img');
        tile.src = 'tiles/' + board[y][x].key + '.jpg';
        tile.id = board[y][x].key;
        tile.addEventListener('click', function() {
            claim();
        });
        document.getElementById(y + '.' + x).appendChild(tile);
        expand(y, x);
      }
      function expand(y, x) {
        if (y == 0) {
          let row = [];
          let base = board[0].length;
          while (row.length != base) {
              row.push(0);
          }
          board.unshift(row);
        }
        if (y == board.length - 1) {
          let row = [];
          let base = board[0].length;
          while (row.length != base) {
              row.push(0);
          }
          board.push(row);
        }
        if (x == 0) {
          for (let row of board) {
              row.unshift(0);
          }
          document.documentElement.style.setProperty("--cols", board[0].length);
        }
        if (x == board[0].length - 1) {
          for (let row of board) {
              row.push(0);
          }
          document.documentElement.style.setProperty("--cols", board[0].length);
        }
        set();
      }
    </script>
</html>
